#!/usr/bin/env bash
set -e

DEPLOY_BRANCH=github-pages
DEPLOY_DIR=github-pages

if [[ -z $1 ]]; then
    echo "Usage: ./bin/deploy [version]"
    exit 1
fi

version=$1

recreate_deployment_branch() {
    if [[ `git branch -a | grep $DEPLOY_BRANCH` ]]; then
        git branch -D $DEPLOY_BRANCH
        git push origin :$DEPLOY_BRANCH
    fi
    git branch $DEPLOY_BRANCH
}

publish_artifacts_to_deployment_branch() {
    git checkout $DEPLOY_BRANCH
    if [[ -d $DEPLOY_DIR ]]; then
        echo yo
        git rm -r $DEPLOY_DIR
    fi

    mkdir -p $DEPLOY_DIR
    cp -p ./out/index.html $DEPLOY_DIR
    cp -p ./out/index.css $DEPLOY_DIR
    cp -p ./out/index.js $DEPLOY_DIR
    cp -p ./out/lua-interop-worker.js $DEPLOY_DIR
    cp -p ./out/lua-interop.wasm $DEPLOY_DIR

    git add $DEPLOY_DIR
    git commit -m "Deploy v$version"
    git push origin $DEPLOY_BRANCH
    git checkout -
}

echo "Deploying v$1"
recreate_deployment_branch
publish_artifacts_to_deployment_branch
echo "Done"
